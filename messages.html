<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Messagerie - √âcole Pas Directe</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: #f0f4f8;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      height: 60px;
      background: #005fa3;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 10;
    }

    #brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      font-size: 1.3rem;
      color: white;
    }

    #brand img {
      height: 40px;
      width: 40px;
      object-fit: cover;
      border-radius: 50%;
    }

    .back-link {
      color: white;
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    .container {
      margin-top: 60px;
      padding: 20px;
      flex-grow: 1;
      display: flex;
      height: calc(100vh - 60px);
    }

    .messaging-container {
      display: flex;
      width: 100%;
      gap: 15px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.05);
      overflow: hidden;
    }

    .conversations-panel {
      flex: 0 0 25%;
      border-right: 1px solid #dee2e6;
      overflow-y: auto;
      background: #f9f9f9;
    }

    .conversations-header {
      padding: 15px;
      border-bottom: 2px solid #005fa3;
      background: white;
      position: sticky;
      top: 0;
    }

    .conversations-header h3 {
      margin: 0;
      color: #005fa3;
      font-size: 1.1rem;
    }

    .conversations-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .conversation-item {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 4px solid transparent;
    }

    .conversation-item:hover {
      background-color: #e8f1f8;
    }

    .conversation-item.active {
      background-color: #e3f2fd;
      border-left-color: #005fa3;
      font-weight: 600;
    }

    .conversation-name {
      font-weight: 600;
      color: #005fa3;
      margin-bottom: 3px;
    }

    .conversation-preview {
      font-size: 0.9rem;
      color: #666;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
    }

    .chat-header {
      padding: 15px;
      border-bottom: 2px solid #005fa3;
      background: #f9f9f9;
    }

    .chat-title {
      margin: 0;
      color: #005fa3;
      font-size: 1.1rem;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .message {
      max-width: 70%;
      padding: 12px 15px;
      border-radius: 8px;
      word-wrap: break-word;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.sent {
      align-self: flex-end;
      background-color: #005fa3;
      color: white;
    }

    .message.received {
      align-self: flex-start;
      background-color: #f0f4f8;
      color: #333;
    }

    .message-sender {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 0.9rem;
    }

    .message-content {
      margin-bottom: 4px;
    }

    .message-time {
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .chat-input-area {
      padding: 15px;
      border-top: 1px solid #dee2e6;
      background: #f9f9f9;
    }

    .chat-form {
      display: flex;
      gap: 10px;
    }

    #message-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
      resize: vertical;
      max-height: 80px;
    }

    .send-btn {
      background-color: #005fa3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      white-space: nowrap;
      transition: background-color 0.3s;
    }

    .send-btn:hover {
      background-color: #00497d;
    }

    .empty-chat {
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
      font-size: 1.1rem;
    }

    .delete-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: background-color 0.3s;
    }

    .delete-btn:hover {
      background-color: #c82333;
    }
  </style>
</head>
<body>

<header>
  <div id="brand">
    <img src="1747986702534.jpeg" alt="Logo" />
    <span>Messagerie</span>
  </div>
  <a href="home.html" class="back-link">‚Üê Retour √† l'accueil</a>
</header>

<div class="container">
  <div class="messaging-container">
    <!-- Panel de conversations -->
    <div class="conversations-panel">
      <div class="conversations-header">
        <h3>üí¨ Conversations</h3>
      </div>
      <ul class="conversations-list" id="conversations-list">
        <!-- Les conversations vont appara√Ætre ici -->
      </ul>
    </div>

    <!-- Panel de chat -->
    <div class="chat-panel">
      <div class="chat-header">
        <h3 class="chat-title" id="chat-title">S√©lectionne une conversation</h3>
        <button class="delete-btn" id="delete-btn" style="display: none;">üóëÔ∏è Effacer la conversation</button>
      </div>

      <div class="chat-messages" id="chat-messages">
        <div class="empty-chat">S√©lectionne une conversation pour commencer</div>
      </div>

      <div class="chat-input-area" id="input-area" style="display: none;">
        <form class="chat-form" id="chat-form">
          <input 
            type="text" 
            id="message-input" 
            placeholder="√âcris ton message..." 
            autocomplete="off"
          />
          <button type="submit" class="send-btn">Envoyer ‚úâÔ∏è</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // V√©rifier l'authentification
  if (sessionStorage.getItem("isLoggedIn") !== "true") {
    window.location.href = "index.html";
  }

  const currentUser = sessionStorage.getItem("currentUser");
  if (!currentUser) {
    sessionStorage.clear();
    window.location.href = "index.html";
  }

  // Initialiser le localStorage avec les messages par d√©faut
  function initializeMessages() {
    if (!localStorage.getItem("schoolMessages")) {
      const defaultMessages = {
        "Alex-Johan": [
          { sender: "Alex", content: "Salut Johan! √áa va?", timestamp: "10:30" },
          { sender: "Johan", content: "Ouais √ßa va! Et toi?", timestamp: "10:35" },
          { sender: "Alex", content: "Bien bien, tu as fais tes devoirs?", timestamp: "10:40" }
        ],
        "Prof. SVT": [
          { sender: "Prof. SVT", content: "Le TP est en ligne sur Moodle.", timestamp: "14:30" }
        ],
        "Prof. Maths": [
          { sender: "Prof. Maths", content: "N'oubliez pas la r√©vision du chapitre 3.", timestamp: "10:15" }
        ],
        "Prof. EPS": [
          { sender: "Prof. EPS", content: "Apportez vos baskets jeudi.", timestamp: "09:00" }
        ],
        "Prof. Fran√ßais": [
          { sender: "Prof. Fran√ßais", content: "Contr√¥le de lecture vendredi.", timestamp: "11:20" }
        ],
        "Prof. Physique": [
          { sender: "Prof. Physique", content: "Les exercices sont √† faire pour demain.", timestamp: "15:00" }
        ]
      };
      localStorage.setItem("schoolMessages", JSON.stringify(defaultMessages));
    }
  }

  const conversationsConfig = {
    "Alex": { name: "Alex", icon: "üë®", key: "Alex-Johan" },
    "Johan": { name: "Johan", icon: "üë®", key: "Alex-Johan" },
    "Prof. SVT": { name: "Prof. SVT", icon: "üë®‚Äçüè´", key: "Prof. SVT" },
    "Prof. Maths": { name: "Prof. Maths", icon: "üìê", key: "Prof. Maths" },
    "Prof. EPS": { name: "Prof. EPS", icon: "‚öΩ", key: "Prof. EPS" },
    "Prof. Fran√ßais": { name: "Prof. Fran√ßais", icon: "üìö", key: "Prof. Fran√ßais" },
    "Prof. Physique": { name: "Prof. Physique", icon: "‚öõÔ∏è", key: "Prof. Physique" }
  };

  let currentConversation = null;

  // Fonction IA simul√©e qui analyse le message et r√©pond intelligemment
  function generateAIResponse(userMessage) {
    const msg = userMessage.toLowerCase();

    // D√©terminer le contexte du message
    if (msg.includes("devoir") || msg.includes("homework") || msg.includes("exercice")) {
      return [
        "As-tu bien compris le chapitre 3? N'h√©site pas si tu as des questions sp√©cifiques sur le devoir! Relire les exemples du cours devrait t'aider. üìù",
        "Je t'ai envoy√© les corrections d√©taill√©es. Regarde-les attentivement et compare avec ta r√©ponse. Si quelque chose n'est pas clair, dis-moi! ‚úÖ",
        "Quand comptes-tu remettre ton devoir? Dis-moi si tu as besoin d'aide pour une question sp√©cifique. Je peux aussi te donner des indices si tu bloques! üë®‚Äçüè´",
        "Le devoir est assez complet, n'oublie pas de justifier tes r√©ponses! As-tu r√©fl√©chi √† la partie 2? C'est la plus importante. üí°"
      ];
    }
    if (msg.includes("note") || msg.includes("points") || msg.includes("r√©sultat") || msg.includes("score")) {
      return [
        "Tu progresses vraiment bien! Continue tes efforts comme √ßa et tu auras d'excellentes notes au prochain contr√¥le. üìà",
        "Excellent travail! Tu as bien compris le cours et √ßa se voit dans ta copie. Bravo pour ta participation en classe! üéâ",
        "Je vais noter √ßa. Ton implication et ta rigueur sont remarquables! Garde ce niveau jusqu'√† la fin de l'ann√©e. ‚≠ê",
        "Tes r√©sultats s'am√©liorent de semaine en semaine. C'est vraiment encourageant! Maintiens cet effort! üèÜ"
      ];
    }
    if (msg.includes("examen") || msg.includes("contr√¥le") || msg.includes("test") || msg.includes("√©valuation")) {
      return [
        "L'examen aura lieu le 20 janvier. Revise bien les chapitres 1-3, c'est sur √ßa qu'on va t'interroger. Je peux te proposer des sujets d'entra√Ænement si tu veux! üìö",
        "Bonne chance pour ton examen! Tu es bien pr√©par√©(e) d'apr√®s ce que j'ai vu en cours. N'oublie pas: arrive 5 minutes avant et am√®ne ton mat√©riel! üí™",
        "Pour bien pr√©parer ton contr√¥le, je te conseille de refaire les exercices du chapitre 2 et 3. Les sujets seront similaires √† ce qu'on a fait ensemble. ‚úèÔ∏è",
        "C'est un test important! As-tu besoin d'une feuille de r√©vision? Je peux t'en envoyer une. Et n'oublie pas: pas de t√©l√©phone pendant l'examen! ‚è∞"
      ];
    }
    if (msg.includes("absent") || msg.includes("malade") || msg.includes("justif") || msg.includes("absence")) {
      return [
        "Apporte-moi un justificatif demain, s'il te pla√Æt! Et rattrape les cours que tu as manqu√©s. Je vais t'envoyer mes notes. üìÑ",
        "Repose-toi bien! Je te donnerai les cours que tu as manqu√©s et un r√©sum√© de ce qu'on a vu. Tu n'auras pas de retard! üè•",
        "Pas de souci, on rattrapera! Envoie-moi un message d√®s que tu es remis(e) et on verra comment te mettre √† jour. ‚ú®",
        "J'esp√®re que tu vas mieux! Quand tu reviens, passe-moi voir pour qu'on v√©rifies que tu as bien compris le chapitre qu'on a √©tudi√©. üíö"
      ];
    }
    if (msg.includes("aide") || msg.includes("comprendre") || msg.includes("expliquer") || msg.includes("comment")) {
      return [
        "Bien s√ªr! C'est une excellente question et je suis content(e) que tu demandes de l'aide. R√©fl√©chis d'abord √† comment tu l'aborderais, puis on en parlera! ü§î",
        "Je vais t'expliquer √ßa plus simplement. Le concept est important pour la suite du cours. On en parlera demain en d√©tail, d'accord? üë®‚Äçüéì",
        "Tr√®s bonne observation! Essaie de relire le paragraphe 2 du cours, tu vas voir que la r√©ponse y est. Si tu as encore du mal, dis-moi! üìñ",
        "C'est normal de pas comprendre du premier coup! Ce sujet est un peu complexe. Laisse-moi te donner un exemple plus simple qui va t'√©clairer. üí≠"
      ];
    }
    if (msg.includes("merci") || msg.includes("merci beaucoup") || msg.includes("gr√¢ce")) {
      return [
        "Avec plaisir! C'est mon travail d'aider mes √©l√®ves √† progresser. Continue comme √ßa! üòä",
        "C'est normal! C'est pour √ßa que je suis l√†. N'h√©site pas si tu as d'autres questions! ‚ú®",
        "Bon courage pour la suite! Vous √™tes une classe formidable et j'aime vous enseigner. üëç",
        "De rien! Ton implication me fait plaisir. C'est des √©l√®ves comme toi qui rendent mon m√©tier sympa! üí™"
      ];
    }
    if (msg.includes("bonjour") || msg.includes("salut") || msg.includes("coucou") || msg.includes("hello")) {
      return [
        "Bonjour! Comment √ßa va? Y a-t-il quelque chose que je peux t'aider avec le cours? üëã",
        "Salut! Besoin d'aide avec quelque chose ou tu viens juste discuter? Je suis dispo! üòä",
        "Coucou! Quoi de neuf? Des questions sur les devoirs ou le cours? üìö",
        "Hello! Comment se passent tes r√©visions? Il y a quelque chose qui te bloque? ü§ì"
      ];
    }
    if (msg.includes("probl√®me") || msg.includes("probleme") || msg.includes("erreur") || msg.includes("bug")) {
      return [
        "D√©cris-moi ton probl√®me plus pr√©cis√©ment. Quel est exactement la difficult√©? Je vais t'aider √† trouver la solution! üîç",
        "√áa arrive √† tout le monde! On va trouver la solution ensemble. Explique-moi √©tape par √©tape ce que tu fais. üí™",
        "Explique-moi exactement ce qui se passe. Je dois comprendre o√π tu bloques pour pouvoir bien t'aider. ü§ù",
        "C'est normal de se tromper! C'est comme √ßa qu'on apprend. Refais-le ensemble, je vais te montrer o√π est l'erreur. ‚úçÔ∏è"
      ];
    }
    if (msg.includes("le√ßon") || msg.includes("chapitre") || msg.includes("cours") || msg.includes("mati√®re")) {
      return [
        "Oui, le dernier chapitre est important pour comprendre la suite! Fais bien attention √† la d√©finition principale. Des questions? üìñ",
        "Bonne question sur ce chapitre! Les points cl√©s sont: la r√©volution, l'impact √©conomique, et les cons√©quences sociales. Lis bien ces parties! üéØ",
        "Ce cours est la base de tout ce qu'on va apprendre cette ann√©e. Je te conseille de bien le ma√Ætriser avant de continuer. ‚≠ê",
        "As-tu lu le chapitre en entier? Parfois les d√©tails au milieu sont importants. Je peux te faire un r√©sum√© si tu veux! üìù"
      ];
    }
    if (msg.includes("participat") || msg.includes("intervenir") || msg.includes("parler en classe")) {
      return [
        "J'aime vraiment quand tu participes en classe! Tes questions sont pertinentes et √ßa aide tout le monde √† mieux comprendre. Continue! üôå",
        "Tu n'as pas besoin d'√™tre parfait(e) pour participer! M√™me une petite id√©e est importante. La classe, c'est un √©change. üí¨",
        "Je suis content(e) que tu poses des questions. C'est le meilleur moyen d'apprendre! Les autres √©l√®ves aussi apprennent de tes remarques. üëè",
        "N'h√©sites pas √† lever la main! Je vois que tu as des choses √† dire et c'est super. C'est comme √ßa qu'on progresse ensemble! ‚ú®"
      ];
    }
    // R√©ponse par d√©faut plus fournie
    return [
      "C'est une excellente question! Je vois que tu r√©fl√©chis profond√©ment au sujet. Dis-moi tes pens√©es et on en parlera! ü§î",
      "Je vois ce que tu veux dire! C'est int√©ressant comme approche. As-tu pens√© √† consulter le chapitre sur ce sujet? üí≠",
      "Interesting observation! Tu as raison sur ce point. C'est important de bien diff√©rencier les cas. Bravo pour cette analyse! üìù",
      "Bonne remarque! Continue comme √ßa, tu montres une vraie capacit√© d'analyse. Je suis impressionn√©(e) par ton engagement! üëç",
      "Je prendrais note de √ßa! C'est exactement le type de r√©flexion que j'aime voir chez mes √©l√®ves. Tr√®s int√©ressant! ‚úçÔ∏è",
      "C'est une question que se posent beaucoup de gens! C'est un bon point de d√©part pour comprendre le sujet en profondeur. Bravo! üåü"
    ];
  }

  // Initialiser les conversations
  function loadConversations() {
    initializeMessages();
    const list = document.getElementById("conversations-list");
    const messagesData = JSON.parse(localStorage.getItem("schoolMessages") || "{}");

    list.innerHTML = "";

    Object.keys(conversationsConfig).forEach(key => {
      const conv = conversationsConfig[key];
      if (conv.name === currentUser) return;

      const li = document.createElement("li");
      li.className = "conversation-item";
      li.setAttribute("data-key", key);
      li.onclick = () => openConversation(key);

      const msgs = messagesData[conv.key] || [];
      const lastMsg = msgs.length > 0 ? msgs[msgs.length - 1] : { content: "Pas de messages" };

      li.innerHTML = `
        <div class="conversation-name">${conv.icon} ${conv.name}</div>
        <div class="conversation-preview">${lastMsg.content}</div>
      `;
      list.appendChild(li);
    });
  }

  // Ouvrir une conversation
  function openConversation(key) {
    currentConversation = key;
    const conv = conversationsConfig[key];

    document.querySelectorAll(".conversation-item").forEach(el => {
      el.classList.remove("active");
    });

    document.querySelector(`[data-key="${key}"]`)?.classList.add("active");
    document.getElementById("chat-title").textContent = `${conv.icon} ${conv.name}`;
    document.getElementById("delete-btn").style.display = "block";
    displayMessages();
    document.getElementById("input-area").style.display = "block";
    document.getElementById("message-input").focus();
  }

  // Afficher les messages
  async function displayMessages() {
    if (!currentConversation) return;

    const conv = conversationsConfig[currentConversation];
    const chatArea = document.getElementById("chat-messages");

    chatArea.innerHTML = "";

    try {
      // Charger depuis localStorage d'abord (plus rapide)
      const messagesData = JSON.parse(localStorage.getItem("schoolMessages") || "{}");
      const msgs = messagesData[conv.key] || [];

      if (!msgs || msgs.length === 0) {
        chatArea.innerHTML = '<div class="empty-chat">Aucun message pour l\'instant</div>';
        return;
      }

      msgs.forEach(msg => {
        const div = document.createElement("div");
        const isOwn = msg.sender === currentUser;
        div.className = `message ${isOwn ? "sent" : "received"}`;
        div.innerHTML = `
          <div class="message-sender">${msg.sender}</div>
          <div class="message-content">${msg.content}</div>
          <div class="message-time">${msg.timestamp}</div>
        `;
        chatArea.appendChild(div);
      });

      setTimeout(() => {
        chatArea.scrollTop = chatArea.scrollHeight;
      }, 50);
    } catch(err) {
      console.error("Erreur chargement messages:", err);
      chatArea.innerHTML = '<div class="empty-chat">Erreur de chargement</div>';
    }
  }

  // Envoyer un message
  document.getElementById("chat-form").addEventListener("submit", async function(e) {
    e.preventDefault();

    if (!currentConversation) {
      alert("S√©lectionne une conversation");
      return;
    }

    const input = document.getElementById("message-input");
    const message = input.value.trim();

    if (message === "") return;

    const conv = conversationsConfig[currentConversation];
    const messagesData = JSON.parse(localStorage.getItem("schoolMessages") || "{}");
    const msgs = messagesData[conv.key] || [];

    const now = new Date();
    const time = now.toLocaleTimeString("fr-FR", { hour: '2-digit', minute: '2-digit' });

    msgs.push({
      sender: currentUser,
      content: message,
      timestamp: time
    });

    messagesData[conv.key] = msgs;
    localStorage.setItem("schoolMessages", JSON.stringify(messagesData));

    displayMessages();
    input.value = "";
    input.focus();

    // R√©ponse automatique pour les profs (avec IA simul√©e)
    if (conv.key !== "Alex-Johan") {
      setTimeout(() => {
        const responses = generateAIResponse(message);
        const response = responses[Math.floor(Math.random() * responses.length)];

        const respTime = new Date();
        respTime.setSeconds(respTime.getSeconds() + 1);
        const respTimeStr = respTime.toLocaleTimeString("fr-FR", { hour: '2-digit', minute: '2-digit' });

        msgs.push({
          sender: conv.name,
          content: response,
          timestamp: respTimeStr
        });

        messagesData[conv.key] = msgs;
        localStorage.setItem("schoolMessages", JSON.stringify(messagesData));
        displayMessages();
      }, 1000);
    }
  });

  // Charger les conversations au d√©marrage
  loadConversations();

  // Bouton pour effacer la conversation
  document.getElementById("delete-btn").addEventListener("click", function() {
    if (!currentConversation) return;

    const confirmed = confirm("Es-tu s√ªr(e) de vouloir effacer tous les messages de cette conversation? Cette action est irr√©versible!");
    if (!confirmed) return;

    const conv = conversationsConfig[currentConversation];
    const messagesData = JSON.parse(localStorage.getItem("schoolMessages") || "{}");

    // Supprimer la conversation
    messagesData[conv.key] = [];
    localStorage.setItem("schoolMessages", JSON.stringify(messagesData));

    // R√©initialiser l'affichage
    document.getElementById("chat-messages").innerHTML = '<div class="empty-chat">Conversation effac√©e. Les messages ont √©t√© supprim√©s.</div>';
    document.getElementById("message-input").value = "";
    
    // Recharger la liste
    loadConversations();
  });
</script>

</body>
</html>
